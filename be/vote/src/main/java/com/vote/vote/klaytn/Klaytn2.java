package com.vote.vote.klaytn;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import com.klaytn.caver.Caver;
import com.klaytn.caver.crpyto.KlayCredentials;
import com.klaytn.caver.fee.FeePayerManager;
import com.klaytn.caver.methods.response.KlayTransactionReceipt;
import com.klaytn.caver.tx.gas.DefaultGasProvider;
import com.klaytn.caver.tx.manager.TransactionManager;
import com.klaytn.caver.tx.model.SmartContractDeployTransaction;
import com.klaytn.caver.tx.model.SmartContractExecutionTransaction;
import com.klaytn.caver.utils.ChainId;
import com.vote.vote.klaytn.smartContract.Riro720m;


import org.json.simple.JSONArray;
// import org.springframework.boot.configurationprocessor.json.JSONObject;
import org.json.simple.JSONObject;
import org.web3j.abi.FunctionEncoder;
import org.web3j.abi.datatypes.Function;
import org.web3j.abi.datatypes.generated.Uint256;
import org.web3j.protocol.core.RemoteCall;
import org.web3j.tuples.generated.Tuple9;
import org.web3j.utils.Numeric;
import org.web3j.abi.datatypes.Utf8String;



//import org.web3j.rlp.*;
public class Klaytn2 {

	
	public JSONObject klaytnDeploy3() throws Exception{
		String sendUser = "0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0"; 
	
		String feeUser = "0xe6dde3422998e00bbd13002e1396388d9b0e4f6ab3de630ce8167ff2c99057f2"; 
		// 수수료 부담하는 사람  Private Key
	
		// 스마트컨트랙트 정보
		String data= "60806040526001805560006002556003805534801561001d57600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600181905550611655806100756000396000f3fe6080604052600436106100f35760003560e01c80638da5cb5b1161008a578063b5aa89eb11610059578063b5aa89eb1461036a578063d0e30db01461039d578063de8fa431146103a7578063e9ab77e5146103d2576100f3565b80638da5cb5b146102b95780639bd575c2146102e4578063a87d942c14610310578063a998590c1461033b576100f3565b806322434836116100c657806322434836146101d757806350c42c78146102145780636eea52511461023f5780637804f3c11461027c576100f3565b806312065fe0146100f557806312514bba14610120578063170ab4051461015d57806317242e8b1461019a575b005b34801561010157600080fd5b5061010a6103fe565b60405161011791906114e7565b60405180910390f35b34801561012c57600080fd5b5061014760048036036101429190810190611114565b61041d565b60405161015491906114cc565b60405180910390f35b34801561016957600080fd5b50610184600480360361017f9190810190611114565b610483565b60405161019191906114cc565b60405180910390f35b3480156101a657600080fd5b506101c160048036036101bc9190810190611179565b610686565b6040516101ce91906114cc565b60405180910390f35b3480156101e357600080fd5b506101fe60048036036101f9919081019061113d565b610717565b60405161020b91906114cc565b60405180910390f35b34801561022057600080fd5b50610229610731565b6040516102369190611338565b60405180910390f35b34801561024b57600080fd5b50610266600480360361026191908101906111e0565b610789565b60405161027391906114cc565b60405180910390f35b34801561028857600080fd5b506102a3600480360361029e91908101906110ad565b610822565b6040516102b091906114cc565b60405180910390f35b3480156102c557600080fd5b506102ce610a5f565b6040516102db919061131d565b60405180910390f35b3480156102f057600080fd5b506102f9610a84565b60405161030792919061135a565b60405180910390f35b34801561031c57600080fd5b50610325610b37565b60405161033291906114e7565b60405180910390f35b34801561034757600080fd5b50610350610b41565b604051610361959493929190611391565b60405180910390f35b34801561037657600080fd5b5061037f610cfe565b60405161039499989796959493929190611407565b60405180910390f35b6103a5610fcc565b005b3480156103b357600080fd5b506103bc611027565b6040516103c991906114e7565b60405180910390f35b3480156103de57600080fd5b506103e7611034565b6040516103f5929190611502565b60405180910390f35b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b6000816104286103fe565b101561043357600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc839081150290604051600060405180830381858888f19350505050158015610479573d6000803e3d6000fd5b5060019050919050565b60005b81600480549050146104c457600460009080600181540180825580915050906001820390600052602060002001600090919290919091505550610486565b5b8160058054905014610503576005600090806001815401808255809150509060018203906000526020600020016000909192909190915055506104c5565b5b816006805490501461054257600660009080600181540180825580915050906001820390600052602060002001600090919290919091505550610504565b5b816007805490501461058157600760009080600181540180825580915050906001820390600052602060002001600090919290919091505550610543565b5b81600880549050146105c057600860009080600181540180825580915050906001820390600052602060002001600090919290919091505550610582565b5b81600980549050146105ff576009600090806001815401808255809150509060018203906000526020600020016000909192909190915055506105c1565b5b81600a805490501461063e57600a60009080600181540180825580915050906001820390600052602060002001600090919290919091505550610600565b5b81600b805490501461067d57600b6000908060018154018082558091505090600182039060005260206000200160009091929091909150555061063f565b60019050919050565b60006106928484610717565b50606082905060008060009050600091505b82518210156106ff5760008383815181106106bb57fe5b602001015160f81c60f81b60f81c60ff169050603081101580156106e0575060398111155b156106f15760308103600a83020191505b5081806001019250506106a4565b61070881610483565b50600193505050509392505050565b600082600281905550816003819055506001905092915050565b6060600480548060200260200160405190810160405280929190818152602001828054801561077f57602002820191906000526020600020905b81548152602001906001019080831161076b575b5050505050905090565b6000846002541115801561079f57506003548511155b1561081457856107ad6103fe565b10156107b857600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc879081150290604051600060405180830381858888f193505050501580156107fe573d6000803e3d6000fd5b5061080a828585610822565b5060019050610819565b600090505b95945050505050565b6000606084905060008060009050600091505b825182101561089057600083838151811061084c57fe5b602001015160f81c60f81b60f81c60ff16905060308110158015610871575060398111155b156108825760308103600a83020191505b508180600101925050610835565b600460018203815481106108a057fe5b906000526020600020016000815480929190600101919050555060018614156108f257600560018203815481106108d357fe5b90600052602060002001600081548092919060010191905055506109d2565b600286141561092a576006600182038154811061090b57fe5b90600052602060002001600081548092919060010191905055506109d1565b6003861415610962576007600182038154811061094357fe5b90600052602060002001600081548092919060010191905055506109d0565b600486141561099a576008600182038154811061097b57fe5b90600052602060002001600081548092919060010191905055506109cf565b60058614156109ce57600960018203815481106109b357fe5b90600052602060002001600081548092919060010191905055505b5b5b5b5b6000851415610a0a57600a60018203815481106109eb57fe5b9060005260206000200160008154809291906001019190505550610a3f565b6001851415610a3e57600b6001820381548110610a2357fe5b90600052602060002001600081548092919060010191905055505b5b600160008154809291906001019190505550600193505050509392505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b606080600a600b81805480602002602001604051908101604052809291908181526020018280548015610ad657602002820191906000526020600020905b815481526020019060010190808311610ac2575b5050505050915080805480602002602001604051908101604052809291908181526020018280548015610b2857602002820191906000526020600020905b815481526020019060010190808311610b14575b50505050509050915091509091565b6000600154905090565b60608060608060606005600660076008600984805480602002602001604051908101604052809291908181526020018280548015610b9e57602002820191906000526020600020905b815481526020019060010190808311610b8a575b5050505050945083805480602002602001604051908101604052809291908181526020018280548015610bf057602002820191906000526020600020905b815481526020019060010190808311610bdc575b5050505050935082805480602002602001604051908101604052809291908181526020018280548015610c4257602002820191906000526020600020905b815481526020019060010190808311610c2e575b5050505050925081805480602002602001604051908101604052809291908181526020018280548015610c9457602002820191906000526020600020905b815481526020019060010190808311610c80575b5050505050915080805480602002602001604051908101604052809291908181526020018280548015610ce657602002820191906000526020600020905b815481526020019060010190808311610cd2575b50505050509050945094509450945094509091929394565b6060806060806060806060806000600460056006600760086009600a600b60015488805480602002602001604051908101604052809291908181526020018280548015610d6a57602002820191906000526020600020905b815481526020019060010190808311610d56575b5050505050985087805480602002602001604051908101604052809291908181526020018280548015610dbc57602002820191906000526020600020905b815481526020019060010190808311610da8575b5050505050975086805480602002602001604051908101604052809291908181526020018280548015610e0e57602002820191906000526020600020905b815481526020019060010190808311610dfa575b5050505050965085805480602002602001604051908101604052809291908181526020018280548015610e6057602002820191906000526020600020905b815481526020019060010190808311610e4c575b5050505050955084805480602002602001604051908101604052809291908181526020018280548015610eb257602002820191906000526020600020905b815481526020019060010190808311610e9e575b5050505050945083805480602002602001604051908101604052809291908181526020018280548015610f0457602002820191906000526020600020905b815481526020019060010190808311610ef0575b5050505050935082805480602002602001604051908101604052809291908181526020018280548015610f5657602002820191906000526020600020905b815481526020019060010190808311610f42575b5050505050925081805480602002602001604051908101604052809291908181526020018280548015610fa857602002820191906000526020600020905b815481526020019060010190808311610f94575b50505050509150985098509850985098509850985098509850909192939495969798565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461102557600080fd5b565b6000600480549050905090565b600080600254600354915091509091565b600082601f83011261105657600080fd5b813561106961106482611558565b61152b565b9150808252602083016020830185838301111561108557600080fd5b61109083828461160c565b50505092915050565b60006110a58235611602565b905092915050565b6000806000606084860312156110c257600080fd5b600084013567ffffffffffffffff8111156110dc57600080fd5b6110e886828701611045565b93505060206110f986828701611099565b925050604061110a86828701611099565b9150509250925092565b60006020828403121561112657600080fd5b600061113484828501611099565b91505092915050565b6000806040838503121561115057600080fd5b600061115e85828601611099565b925050602061116f85828601611099565b9150509250929050565b60008060006060848603121561118e57600080fd5b600061119c86828701611099565b93505060206111ad86828701611099565b925050604084013567ffffffffffffffff8111156111ca57600080fd5b6111d686828701611045565b9150509250925092565b600080600080600060a086880312156111f857600080fd5b600061120688828901611099565b955050602061121788828901611099565b945050604061122888828901611099565b935050606061123988828901611099565b925050608086013567ffffffffffffffff81111561125657600080fd5b61126288828901611045565b9150509295509295909350565b600061127b83836112ff565b60208301905092915050565b611290816115ba565b82525050565b60006112a182611591565b6112ab81856115a9565b93506112b683611584565b60005b828110156112e4576112cc86835161126f565b95506112d78261159c565b91506001810190506112b9565b50849250505092915050565b6112f9816115cc565b82525050565b611308816115f8565b82525050565b611317816115f8565b82525050565b60006020820190506113326000830184611287565b92915050565b600060208201905081810360008301526113528184611296565b905092915050565b600060408201905081810360008301526113748185611296565b905081810360208301526113888184611296565b90509392505050565b600060a08201905081810360008301526113ab8188611296565b905081810360208301526113bf8187611296565b905081810360408301526113d38186611296565b905081810360608301526113e78185611296565b905081810360808301526113fb8184611296565b90509695505050505050565b6000610120820190508181036000830152611422818c611296565b90508181036020830152611436818b611296565b9050818103604083015261144a818a611296565b9050818103606083015261145e8189611296565b905081810360808301526114728188611296565b905081810360a08301526114868187611296565b905081810360c083015261149a8186611296565b905081810360e08301526114ae8185611296565b90506114be61010083018461130e565b9a9950505050505050505050565b60006020820190506114e160008301846112f0565b92915050565b60006020820190506114fc600083018461130e565b92915050565b6000604082019050611517600083018561130e565b611524602083018461130e565b9392505050565b6000604051905081810181811067ffffffffffffffff8211171561154e57600080fd5b8060405250919050565b600067ffffffffffffffff82111561156f57600080fd5b601f19601f8301169050602081019050919050565b6000602082019050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b60006115c5826115d8565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000819050919050565b8281833760008383015250505056fea265627a7a72305820ea77026481fd352723a11a029719c5d8946f11df3d3ceb649e8ab17053a3951b6c6578706572696d656e74616cf50037";
	
	
		
		// caver & 계정 로드
		Caver caver = Caver.build(Caver.BAOBAB_URL);
		KlayCredentials sender = KlayCredentials.create(sendUser);
		
		// SmartContracdeployTransaction 생성
		SmartContractDeployTransaction smartContractDeployTransaction = SmartContractDeployTransaction.create(
				sender.getAddress(), // 컨트렉트를 배포하고자 하는 계정의 주소
				BigInteger.ZERO, 
				Numeric.hexStringToByteArray(data), 
				new DefaultGasProvider().getGasLimit(), 
				BigInteger.ZERO);
		
		// sender의 계정으로 TransactionManager 인스턴스 생성
		TransactionManager txManager
			= new TransactionManager
				.Builder(caver, sender)
				.setChaindId(ChainId.BAOBAB_TESTNET).build();
		
		String senderRawTransaction
			= txManager.sign(smartContractDeployTransaction, true).getValueAsString();
		
		KlayCredentials feePayer = KlayCredentials.create(feeUser);
		
		FeePayerManager feePayerManager
			= new FeePayerManager.Builder(caver,  feePayer)
				.setChainId(ChainId.BAOBAB_TESTNET).build();
		KlayTransactionReceipt.TransactionReceipt transactionReceipt 
			= feePayerManager.executeTransaction(senderRawTransaction);
		
		String txHash = transactionReceipt.getTransactionHash(); 
		String deployedContractAddress = transactionReceipt.getContractAddress();
		String errorMessage = transactionReceipt.getErrorMessage();
		
		System.out.println("txHash : "+txHash);
		System.out.println("deployedContractAddress : " + deployedContractAddress);
		System.out.println("errorMessage : " + errorMessage);
	
		JSONObject result = new JSONObject();
		result.put("address",deployedContractAddress);
		return result;
	}


	public JSONObject klaytnSend3(String address, long time, int age, int gender, int select )throws Exception{ 
		Caver caver = Caver.build(Caver.BAOBAB_URL);

		KlayCredentials sender = KlayCredentials.create("0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0");
		//
//			byte[] byteArray=str.getBytes();
		
//			byte[] byteArray2 = "1212".getBytes();
//			String hexValue = javax.xml.bind.DatatypeConverter.printHexBinary(byteArray2);
		
		
		//Input byte array must be in range 0 < M <= 32 and length must match type 오류남.
		// 자바에선 16 비트 ? 로 바꿔서 길이가 63 ? 64 인데 , bytes32 에서는 길이를 32 까지 허용하니, 길이 오류가 남.
		
		// 파라메터 1 : 1: klay ? gass , 2: nowTime,   3:age, 4: gender, last: Seleted
		String selectStr = Integer.toString(select);
		System.out.println("----------------------------------------send");
		Function function = new Function(
			Riro720m.FUNC_TRANSFERWITHDATA,  // FUNC_TRANSFER = "transfer"
		        Arrays.asList(
		        		
						new Uint256(BigInteger.ZERO),
						new Uint256(time),
						new Uint256(age),
						new Uint256(gender),
						new Utf8String(selectStr)
						
		        		
		        		),  // inputParameters
		        Collections.emptyList()  // outputParameters          
		);
		String data = FunctionEncoder.encode(function);
		
		TransactionManager txManager = new TransactionManager.Builder(caver, sender)
                .setChaindId(ChainId.BAOBAB_TESTNET).build();
		
		System.out.println("----------------------------------------send 1");

		SmartContractExecutionTransaction smartContractExecutionTransaction
			= SmartContractExecutionTransaction.create(
				sender.getAddress(),//만드는 User 의 address
				address,
		        BigInteger.ZERO,
		        Numeric.hexStringToByteArray(data),       
//			        sendData, //전송할 데이터
		        new DefaultGasProvider().getGasLimit(Riro720m.FUNC_TRANSFER)
//			        BigInteger.valueOf(100_000)
		);
		System.out.println("smartContractExecutionTransaction:" +smartContractExecutionTransaction);
		String rawTransaction
		        = txManager.sign(smartContractExecutionTransaction, true).getValueAsString();
				System.out.println("----------------------------------------send 2");
		KlayCredentials feePayer = KlayCredentials.create("0xe6dde3422998e00bbd13002e1396388d9b0e4f6ab3de630ce8167ff2c99057f2");// 수수료 부담하는 사람의 private key
		FeePayerManager feePayerManager
		        = new FeePayerManager.Builder(caver, feePayer)
		        		.build();
//			                .setChainId(ChainId.BAOBAB_TESTNET).build();
		//Sync : FeePayer ExecuteTx

		System.out.println("----------------------------------------send 3");

		KlayTransactionReceipt.TransactionReceipt transactionReceipt 
			= feePayerManager.executeTransaction(rawTransaction);
		String errorMessage = transactionReceipt.getErrorMessage();
		String txHash = transactionReceipt.getTransactionHash();
		
		System.out.println("txHash: "+txHash);
		System.out.println("errorMessage : "+ errorMessage);

		System.out.println("----------------------------------------send 4");
		JSONObject json = new JSONObject();
		json.put("hash",txHash);
		return json;
	}
	
	
	public JSONObject klaytnSetOptions2(String address, long startTime, long endTime, int limit) throws Exception{
		Caver caver = Caver.build(Caver.BAOBAB_URL);

		KlayCredentials sender = KlayCredentials.create("0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0");
		//
//			byte[] byteArray=str.getBytes();
		
//			byte[] byteArray2 = "1212".getBytes();
//			String hexValue = javax.xml.bind.DatatypeConverter.printHexBinary(byteArray2);
		
		
		//Input byte array must be in range 0 < M <= 32 and length must match type 오류남.
		// 자바에선 16 비트 ? 로 바꿔서 길이가 63 ? 64 인데 , bytes32 에서는 길이를 32 까지 허용하니, 길이 오류가 남.
		
	//uint _startTime, uint _endTime, uint _limit, uint _state, uint _resultTime  
	// 1. 시작시간, 2. 마감시간, 3. 후보수, 
		String limitstr = Integer.toString(limit);
		Function function = new Function(
			Riro720m.FUNC_SETOPTIONS,  // FUNC_TRANSFER = "transfer"
		        Arrays.asList(
		        		
		        		new Uint256(startTime),
						new Uint256(endTime),
						new Utf8String(limitstr)

		        		),  // inputParameters
		        Collections.emptyList()  // outputParameters          
		);
		String data = FunctionEncoder.encode(function);
		
		TransactionManager txManager = new TransactionManager.Builder(caver, sender)
                .setChaindId(ChainId.BAOBAB_TESTNET).build();
		
		SmartContractExecutionTransaction smartContractExecutionTransaction
			= SmartContractExecutionTransaction.create(
				sender.getAddress(),//만드는 User 의 address
				address,
		        BigInteger.ZERO,
		        Numeric.hexStringToByteArray(data),       
//			        sendData, //전송할 데이터
		        new DefaultGasProvider().getGasLimit(Riro720m.FUNC_TRANSFER)
//			        BigInteger.valueOf(100_000)
		);
		System.out.println("smartContractExecutionTransaction:" +smartContractExecutionTransaction);
		String rawTransaction
		        = txManager.sign(smartContractExecutionTransaction, true).getValueAsString();
		
		KlayCredentials feePayer = KlayCredentials.create("0xe6dde3422998e00bbd13002e1396388d9b0e4f6ab3de630ce8167ff2c99057f2");// 수수료 부담하는 사람의 private key
		FeePayerManager feePayerManager
		        = new FeePayerManager.Builder(caver, feePayer)
		        		.build();
//			                .setChainId(ChainId.BAOBAB_TESTNET).build();
		//Sync : FeePayer ExecuteTx
		KlayTransactionReceipt.TransactionReceipt transactionReceipt 
			= feePayerManager.executeTransaction(rawTransaction);
			// transactionReceipt.get
		String errorMessage = transactionReceipt.getErrorMessage();
		String txHash = transactionReceipt.getTransactionHash();
		
		System.out.println("txHash: "+txHash);
		System.out.println("errorMessage : "+ errorMessage);

		JSONObject json = new JSONObject();
		json.put("hash",txHash);
		return json;
	}
	public JSONArray load3(String address) throws Exception{// 배포된 스마트 컨트렉트의 uint List 출력, count 출력 
		Caver caver = Caver.build(Caver.BAOBAB_URL);
		
		KlayCredentials credentials = KlayCredentials.create("0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0");
		
//			0xcc1b2b7db95514cced8b7dcb169470eeda34ca76    -  대납
		Riro720m eeToken = Riro720m.load(
//					"0x7b6c602b7e8dde60f16ec0684421d69868215f25",// 콘트렉트 adress 
//					"0x3970bec0c994b437d4bb2ccc277e965ce24f9ff6",
//					"0xb9be5c12aaf13a18e866883fccfa3327283d4891",
				// "0x3caef473574f6a9de0501d3073c5300e5a05ed1d",
				address,
				caver, 
				credentials, 
				ChainId.BAOBAB_TESTNET,
				new DefaultGasProvider());

		JSONArray json = new JSONArray();

		try{
			RemoteCall<Tuple9<List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, BigInteger>> remoteCall 
			= eeToken.getListTotal();
			
		Tuple9<List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,BigInteger> result = remoteCall.send();
		
		List<BigInteger> voteResult = result.getValue1();
		List<BigInteger> voteAge1 = result.getValue2();
		List<BigInteger> voteAge2 = result.getValue3();
		List<BigInteger> voteAge3 = result.getValue4();
		List<BigInteger> voteAge4 = result.getValue5();
		List<BigInteger> voteAge5 = result.getValue6();
		List<BigInteger> voteGender0 = result.getValue7();
		List<BigInteger> voteGender1 = result.getValue8();
		BigInteger count = result.getValue9();


		

		json.add(0, voteResult);


		JSONObject age = new JSONObject();

		for (int i=1; i<=voteResult.size(); i++){
			ArrayList data = new ArrayList();
			
			data.add(voteAge1.get(i-1));
			data.add(voteAge2.get(i-1));
			data.add(voteAge3.get(i-1));
			data.add(voteAge4.get(i-1));
			data.add(voteAge5.get(i-1));

			age.put(i,data);
		}
		json.add(1,age);

		JSONObject gender = new JSONObject();

		for (int i=0; i<voteResult.size(); i++){
			ArrayList data = new ArrayList();
			
			data.add(voteGender0.get(i));
			data.add(voteGender1.get(i));
			

			gender.put(i+1,data);
		}

		json.add(2,gender);
		json.add(3,count);




		}catch(Exception e){
			e.printStackTrace();
		}
			
		// json.put("count",eeToken.getCount().send());
		return json;
	}

}
// 

